# Emulator Core Requirement Matrix

- Last updated: 2026-02-13
- Source PRD: `docs/emulator/emulator-core-prd.md` (Draft v0.1)
- Scope: traceability map from PRD requirements to implementation modules and
  tests in `crates/emulator-core`

## Usage

- `Planned` means target module/test paths are reserved but not implemented yet.
- Every new emulator-core implementation PR should update this matrix and link
  test IDs for touched rows.

## Implemented Artifacts

- Fault taxonomy scaffold (`FaultCode`, `FaultClass`) is implemented in
  `crates/emulator-core/src/fault.rs` with stable code mapping tests. This
  artifact establishes shared fault language for FR-2, FR-6, FR-13, and NFR-3.
- Cycle-cost table artifact (`CycleCostKind`, `CYCLE_COST_TABLE`, `cycle_cost`)
  is implemented in `crates/emulator-core/src/timing.rs` with table-consumer
  tests. This artifact establishes a single timing source of truth for FR-5.

## Requirement Traceability

| ID    | PRD Requirement                                 | Implementation module(s) (planned)                                                                                                                                                                                             | Test file(s) (planned)                                                                                                                                   | Status  |
| ----- | ----------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------- | ------- |
| FR-1  | Architectural state and register semantics      | `crates/emulator-core/src/state/registers.rs`, `crates/emulator-core/src/state/flags.rs`, `crates/emulator-core/src/core.rs`                                                                                                   | `crates/emulator-core/tests/fr1_arch_state.rs`, `crates/emulator-core/tests/fr1_flags.rs`                                                                | Planned |
| FR-2  | Memory map and access policy                    | `crates/emulator-core/src/memory/map.rs`, `crates/emulator-core/src/memory/access.rs`, `crates/emulator-core/src/fault.rs`                                                                                                     | `crates/emulator-core/tests/fr2_memory_regions.rs`, `crates/emulator-core/tests/fr2_alignment_endianness.rs`                                             | Planned |
| FR-3  | Instruction set support and semantic edge rules | `crates/emulator-core/src/decode/decoder.rs`, `crates/emulator-core/src/execute/control.rs`, `crates/emulator-core/src/execute/alu.rs`, `crates/emulator-core/src/execute/math.rs`, `crates/emulator-core/src/execute/data.rs` | `crates/emulator-core/tests/fr3_opcode_semantics.rs`, `crates/emulator-core/tests/fr3_flags_table.rs`, `crates/emulator-core/tests/fr3_div_mod_zero.rs`  | Planned |
| FR-4  | Addressing modes and AM validation              | `crates/emulator-core/src/decode/addressing.rs`, `crates/emulator-core/src/execute/effective_address.rs`                                                                                                                       | `crates/emulator-core/tests/fr4_addressing_modes.rs`, `crates/emulator-core/tests/fr4_am010_sign_ext.rs`                                                 | Planned |
| FR-5  | Deterministic timing model and budget           | `crates/emulator-core/src/timing.rs`, `crates/emulator-core/src/execute/retire.rs`                                                                                                                                             | `crates/emulator-core/tests/fr5_cycle_costs.rs`, `crates/emulator-core/tests/fr5_budget_fault.rs`                                                        | Planned |
| FR-6  | Dispatch and fault semantics                    | `crates/emulator-core/src/dispatch.rs`, `crates/emulator-core/src/fault.rs`, `crates/emulator-core/src/execute/control.rs`                                                                                                     | `crates/emulator-core/tests/fr6_dispatch.rs`, `crates/emulator-core/tests/fr6_handler_context.rs`, `crates/emulator-core/tests/fr6_double_fault.rs`      | Planned |
| FR-6A | Commit order contract                           | `crates/emulator-core/src/execute/commit.rs`, `crates/emulator-core/src/execute/pipeline.rs`                                                                                                                                   | `crates/emulator-core/tests/fr6a_commit_order.rs`, `crates/emulator-core/tests/fr6a_precise_faults.rs`                                                   | Planned |
| FR-7  | Event queue behavior                            | `crates/emulator-core/src/event_queue.rs`, `crates/emulator-core/src/dispatch.rs`                                                                                                                                              | `crates/emulator-core/tests/fr7_event_queue.rs`, `crates/emulator-core/tests/fr7_overflow.rs`                                                            | Planned |
| FR-8  | MMIO contract and ordering                      | `crates/emulator-core/src/mmio.rs`, `crates/emulator-core/src/execute/memory_ops.rs`, `crates/emulator-core/src/execute/control.rs`                                                                                            | `crates/emulator-core/tests/fr8_mmio_contract.rs`, `crates/emulator-core/tests/fr8_ordering_sync.rs`                                                     | Planned |
| FR-9  | Snapshot and replay primitives                  | `crates/emulator-core/src/snapshot.rs`, `crates/emulator-core/src/replay.rs`, `crates/emulator-core/src/core.rs`                                                                                                               | `crates/emulator-core/tests/fr9_snapshot_roundtrip.rs`, `crates/emulator-core/tests/fr9_replay_determinism.rs`                                           | Planned |
| FR-10 | Reset and boot semantics                        | `crates/emulator-core/src/reset.rs`, `crates/emulator-core/src/core.rs`, `crates/emulator-core/src/state/capabilities.rs`                                                                                                      | `crates/emulator-core/tests/fr10_reset_boot.rs`                                                                                                          | Planned |
| FR-11 | External event injection contract               | `crates/emulator-core/src/api.rs`, `crates/emulator-core/src/event_queue.rs`                                                                                                                                                   | `crates/emulator-core/tests/fr11_event_injection.rs`                                                                                                     | Planned |
| FR-12 | DIAG window semantics                           | `crates/emulator-core/src/diag/mod.rs`, `crates/emulator-core/src/diag/provider.rs`, `crates/emulator-core/src/fault.rs`                                                                                                       | `crates/emulator-core/tests/fr12_diag_window.rs`, `crates/emulator-core/tests/fr12_diag_saturation.rs`                                                   | Planned |
| FR-13 | MMIO authorization semantics                    | `crates/emulator-core/src/mmio.rs`, `crates/emulator-core/src/diag/mod.rs`, `crates/emulator-core/src/fault.rs`                                                                                                                | `crates/emulator-core/tests/fr13_mmio_authorization.rs`                                                                                                  | Planned |
| FR-14 | Capability-bit enforcement                      | `crates/emulator-core/src/state/capabilities.rs`, `crates/emulator-core/src/execute/capability_checks.rs`                                                                                                                      | `crates/emulator-core/tests/fr14_capability_gating.rs`                                                                                                   | Planned |
| FR-15 | Run-state and boundary semantics                | `crates/emulator-core/src/run_state.rs`, `crates/emulator-core/src/timing.rs`, `crates/emulator-core/src/execute/control.rs`                                                                                                   | `crates/emulator-core/tests/fr15_ewait_halt.rs`, `crates/emulator-core/tests/fr15_boundary_transitions.rs`                                               | Planned |
| NFR-1 | Determinism                                     | `crates/emulator-core/src/core.rs`, `crates/emulator-core/src/replay.rs`, `crates/emulator-core/src/timing.rs`                                                                                                                 | `crates/emulator-core/tests/nfr1_determinism_cross_run.rs`, `crates/emulator-core/tests/nfr1_determinism_ci.rs`                                          | Planned |
| NFR-2 | Performance envelope (post-v0.1)                | `crates/emulator-core/benches/step_throughput.rs`                                                                                                                                                                              | `crates/emulator-core/tests/nfr2_perf_smoke.rs`                                                                                                          | Planned |
| NFR-3 | Safety and correctness                          | `crates/emulator-core/src/fault.rs`, `crates/emulator-core/src/decode/decoder.rs`, `crates/emulator-core/fuzz/fuzz_targets/*`                                                                                                  | `crates/emulator-core/tests/nfr3_no_panic.rs`, `crates/emulator-core/tests/nfr3_illegal_faults.rs`, `crates/emulator-core/tests/nfr3_property_memory.rs` | Planned |
| NFR-4 | Inspectability and trace stability              | `crates/emulator-core/src/trace.rs`, `crates/emulator-core/src/api.rs`                                                                                                                                                         | `crates/emulator-core/tests/nfr4_trace_hooks.rs`, `crates/emulator-core/tests/nfr4_trace_golden.rs`                                                      | Planned |

## Acceptance Criteria Traceability

| ID   | PRD Acceptance Criterion                                                                      | Primary test file(s) (planned)                                                                                                                               | Linked requirement rows |
| ---- | --------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------------------- |
| AC-1 | Implemented instructions pass conformance vectors and edge-case tests                         | `crates/emulator-core/tests/fr3_opcode_semantics.rs`, `crates/emulator-core/tests/fr3_flags_table.rs`, `crates/emulator-core/tests/conformance_vectors.rs`   | FR-3, FR-4, FR-6A       |
| AC-2 | Deterministic replay passes across at least two macOS/Linux CI runners                        | `crates/emulator-core/tests/fr9_replay_determinism.rs`, `crates/emulator-core/tests/nfr1_determinism_ci.rs`                                                  | FR-9, NFR-1             |
| AC-3 | Tick budget and fault semantics match canonical behavior                                      | `crates/emulator-core/tests/fr5_budget_fault.rs`, `crates/emulator-core/tests/fr6_dispatch.rs`, `crates/emulator-core/tests/fr15_boundary_transitions.rs`    | FR-5, FR-6, FR-15       |
| AC-4 | No guest input crashes host process under fuzz stress budget                                  | `crates/emulator-core/fuzz/fuzz_targets/decode.rs`, `crates/emulator-core/fuzz/fuzz_targets/execute.rs`, `crates/emulator-core/tests/nfr3_no_panic.rs`       | NFR-3                   |
| AC-5 | Reset/boot, DIAG latching, and precise-fault behavior pass dedicated conformance scenarios    | `crates/emulator-core/tests/fr10_reset_boot.rs`, `crates/emulator-core/tests/fr12_diag_window.rs`, `crates/emulator-core/tests/fr6a_precise_faults.rs`       | FR-10, FR-12, FR-6A     |
| AC-6 | Capability gating, EWAIT/HALT semantics, and handler-context fault semantics pass conformance | `crates/emulator-core/tests/fr14_capability_gating.rs`, `crates/emulator-core/tests/fr15_ewait_halt.rs`, `crates/emulator-core/tests/fr6_handler_context.rs` | FR-14, FR-15, FR-6      |
